title: オフィスで無線LANトラブルと戦った話
tag: IEEE802.11ac IEEE802.11n

どうも、無線おじさんです。みなさん、おもしろデバイスで遊んでいますか？
私はつい最近なんですが、初めて山でのアマチュア無線の通常運用をしました。山は電波が良く飛びますね。今年はオフィスでも無線について考える機会を得てしまいました。最近の無線 LAN のアクセスポイント（AP）が結構なおもしろデバイスだったので1ネタ紹介します。

本記事の題材は無線 LAN の障害対応についてです。無線 LAN は皆さんも普段から何気なく利用していると思いますが、この手の試行錯誤した記事を見ることはあまりないかと思います。もし無線 LAN でお困りの方がいましたら本記事が参考になれば幸いです。

## 結論

オフィスでの無線 LAN 環境の構築の際に知っておいて欲しいことを先に書きます。

### 無線 LAN のセルサイズは小さくしよう！！

（セルサイズというのは通信範囲のことです。もちろん大きいセルサイズが適する場面もあります。）

----

## 障害発生
ある日突然インターネットが使えなくなった。

- ほぼ連日のほぼ同じ時間帯に発生
- ある AP では利用者が少なく、ある AP では利用者が多い
- 利用者が少ない AP ではインターネットが使える
- 無線 LAN 時のインターネット接続が遅い、不安定
    - 同タイミングで有線 LAN がどうなっていたか未確認

以上のことから特定の AP に接続が集中していたので無線 LAN に問題があると考えた。高密度環境における無線 LAN 構築といえばセルサイズの縮小化が必要だ。ではどうすればいい？

## IEEE 802.11ac
答えはゴッドファーザーにあった。
[802.11ac：第 5 世代の Wi-Fi 規格 テクニカル ホワイト ペーパー - Cisco](https://www.cisco.com/c/ja_jp/products/collateral/wireless/aironet-3600-series/white_paper_c11-713103.html)

MU-MIMO は特に素晴しい。AP から端末への同時通信に限定されるが、これが使えれば無線 LAN 利用者が増えていってもパフォーマンス的に不安にならないだろう。AP と端末の両方が対応していてというのはすぐには無理だが、まずは 802.11ac への移行が必要だ。

MU-MIMO については以下を参照。

- 一問一答 [Cisco 802.11ac Wave 2 FAQ - Cisco](https://www.cisco.com/c/ja_jp/solutions/collateral/enterprise-networks/802-11ac-solution/q-and-a-c67-734152.html)
- 図解 [802.11ac REFERENCE](https://www.arubanetworks.com/assets/poster_wave2.pdf)

※ ゴッドファーザー未試聴です。

----

## 初期状態

- 居室内のほぼ全ての端末が無線 LAN 接続を利用
- AP は2台体制
- AP1 は物陰に設置
- AP2 はギリギリ視認できる場所に設置
- AP1 と AP2 の間で負荷分散を行なっていない
- どちらの AP も 2.4GHz & 5GHz の 802.11n、または 802.11ac を提供
- どちらの AP も MU-MIMO 非対応
- AP1 配下の有線 LAN ポートに IP 電話機が繋っている
- 近隣は 2.4GHz 帯の AP で溢れ返っている

図の通り AP2 が色々なところから接続されていた。見た目通り AP2 のセルサイズが大きい。まずは 2.4GHz 帯の廃止によるセルサイズの縮小と 802.11ac 接続への変更を検討する。

|![test.002.png](https://qiita-image-store.s3.amazonaws.com/0/4162/4785f822-bcaa-c5af-16f3-1e16639f48ba.png)|
|:-:|
※ 四角い物は机です。机の数は適当です。

## 対応1
- 音声通信する端末を有線 LAN 接続に変更
- 5GHz 帯利用を主、2.4GHz 帯利用を副
  - AP2 から 2.4GHz 帯を停波することによる負荷軽減
  - 代わりに 2.4GHz 帯専用の AP3 を追加して全3台体制に変更
  - 2.4GHz 帯はプリンタやスキャナ用途

何はともあれ障害の影響を受けていた音声通信に対策を施した。音声は双方向の通信をできる限り持続する必要がある。よって無線 LAN を使うと電波の占有時間が長い。この問題に対して WMM のパラメータ調整も有益だったかもしれないが有線 LAN 接続に変更した。端末の数だけ全二重通信を維持できるようになったので効果は絶大だった。ただし全体的には障害が起きるまでの状態に少し余裕ができただけ。障害は相変らず起きていた。

|![test.003.png](https://qiita-image-store.s3.amazonaws.com/0/4162/bb0439e8-8c4c-b60d-2282-543e0c47171c.png)|
|:-:|

## 対応2
- AP1 を目視できる場所に移動して電波の到達距離を稼ぐ
    - オフィスに余っていた [パソコンスタンド](https://www.amazon.co.jp/gp/product/B01DBI2UBY) を使った
- AP2 を移動してセルサイズ縮小
- AP3 は 2.4GHz 帯のゲスト専用 SSID に変更
- 2.4GHz 帯しか使えない端末専用の SSID を AP1 から発信
- IP 電話の PPPoE セッションを分ける
  - 障害発生時に IP 電話が使えなければインターネット回線に問題があると判断できる
  - IP 電話の回線品質の安定化

AP2 は混雑したままだったが障害は減った。

|![test.004.png](https://qiita-image-store.s3.amazonaws.com/0/4162/27bb8e46-37aa-8880-1560-4e32b3a02d2e.png)|
|:-:|

## 対応3
- AP4 を追加して全4台体制に
- AP1、AP2、AP4 のチャネルを W52 の中でズラして固定化
  - DFS 対応
  - W52 しか使えない端末への配慮
- AP3 を AP5 に変更して AP2 のセルサイズ縮小
- 2.4GHz 帯しか使えない端末専用の SSID を AP4 から発信

MI-MIMO が使える AP が調達できた。セルサイズに関しても落ち付いてきて障害も終息した。ただし 5GHz 帯への相性がどうしても悪い端末があるということも分かってきた。そういうときは MU-MIMO が使える無線 LAN 子機を別途購入して対応した。

|![test.006.png](https://qiita-image-store.s3.amazonaws.com/0/4162/1e0f40e3-1396-147c-5bb6-8e67994aba07.png)|
|:-:|

## 対応4
障害発生から大体2ヶ月後。現在の構成。

- 音声通信する端末を有線 LAN 接続に変更
- AP2 を AP6 に変更して同時通信数・同時接続数の増強
- AP4 を AP7 に変更して同時通信数・同時接続数の増強
- AP6 と AP7 の間で負荷分散
  - 802.11k, 802.11v, 802.11r ベースのクライアントステアリング
- 会議室エリアに有線 LAN を延伸

MU-MIMO の使える端末はまだ少ないが今後に期待。

|![test.007.png](https://qiita-image-store.s3.amazonaws.com/0/4162/29fd322e-04ef-87e6-27da-0639e3a45cfc.png)|
|:-:|

## まとめ
802.11ac と MU-MIMO 万歳です。802.11n は廃止できなかったけど、無線 LAN の問題について当面どうにかなるでしょう。もし 802.11ax が利用できる時代であれば OFDMA のお陰で問題が解決ができた！と興奮していたことでしょうが 2020 年頃までお預けのようです。
 [IEEE P802.11 - TASK GROUP AX](http://www.ieee802.org/11/Reports/tgax_update.htm)

無線 LAN というのは今や誰でもどこでも使えるのが当たり前になっています。その反面、問題が起きたときの無力感はなかなかのものです。業者への委託も今回検討しましたが、業者を見極めるためにも多少のことは知っておかないといけないな、というのも今回得られた発見の1つでした。

記事を読んでくれた方は計画的な無線 LAN 増強を目指してください。
